‚öôÔ∏è Node Tuning and Performance Profiles in OpenShift

üß© 1. Why Node Tuning is Needed
By default, OpenShift nodes run with general-purpose kernel and system tuning.
But in some environments ‚Äî especially NFV (Network Function Virtualization), AI/ML, real-time, 
or high-performance computing (HPC) ‚Äî you need to tune CPU, memory, kernel, and IRQ settings for better latency or throughput.

To handle this, OpenShift provides:
| Component                            | Purpose                                                                |
| ------------------------------------ | ---------------------------------------------------------------------- |
| **Node Tuning Operator (NTO)**       | Manages system tuning via Tuned profiles                               |
| **Performance Addon Operator (PAO)** | Automates advanced node performance settings using PerformanceProfiles |

üß† 2. Node Tuning Operator (NTO)
üîπ Purpose
The Node Tuning Operator manages and applies Tuned profiles across cluster nodes.
It automatically detects node roles and applies appropriate performance settings (like kernel parameters, sysctl, and CPU isolation).

üîπ Key CRDs managed by NTO
| CRD         | Description                                                      |
| ----------- | ---------------------------------------------------------------- |
| **Tuned**   | Defines custom tuning settings (sysctl, scheduler, kernel, etc.) |
| **Profile** | Automatically generated by NTO per node to apply Tuned configs   |

üîß Example: Default Tuned Profiles
| Profile                   | Description                            |
| ------------------------- | -------------------------------------- |
| `openshift-node`          | Default profile for all nodes          |
| `openshift-control-plane` | Profile for master/control-plane nodes |
| `openshift-etcd`          | For etcd nodes                         |
| `openshift-realtime`      | For real-time optimized workloads      |

You can list them with:
oc get tuned -n openshift-cluster-node-tuning-operator

üßæ 3. Custom Tuned Profile Example
Suppose you want to set kernel parameters for better network performance.

YAML Example:
apiVersion: tuned.openshift.io/v1
kind: Tuned
metadata:
  name: custom-net-tuning
  namespace: openshift-cluster-node-tuning-operator
spec:
  profile:
  - name: custom-net
    data: |
      [main]
      summary=Custom network tuning
      include=openshift-node

      [sysctl]
      net.core.rmem_max=134217728
      net.core.wmem_max=134217728
      net.ipv4.tcp_rmem=4096 87380 67108864
      net.ipv4.tcp_wmem=4096 65536 67108864

  recommend:
  - match:
    - label: "node-role.kubernetes.io/worker"
    priority: 10
    profile: "custom-net"

Explanation:
Applies on nodes labeled worker.
Extends the default profile openshift-node.
Adjusts kernel network buffers for high throughput.

Apply it:
oc apply -f custom-net-tuning.yaml

Check status:
oc get tuned -n openshift-cluster-node-tuning-operator
oc logs -n openshift-cluster-node-tuning-operator daemonset/tuned

üß© 4. Performance Addon Operator (PAO)
The Performance Addon Operator (PAO) builds on NTO and MCO to apply low-latency, CPU isolation, and NUMA-aware tuning automatically.
It‚Äôs mostly used in Telco (RAN), real-time, and DPDK workloads.
It introduces a higher-level abstraction: PerformanceProfile.

‚öôÔ∏è 5. PerformanceProfile Explained
A PerformanceProfile defines:
CPU allocation for workloads vs OS/system processes
Hugepages setup
Real-time kernel usage
Power management settings
NUMA and IRQ balancing policies
Integration with NTO (via Tuned profiles)
Integration with MCO (to reboot/reconfigure nodes)

üîß Example: PerformanceProfile YAML
apiVersion: performance.openshift.io/v2
kind: PerformanceProfile
metadata:
  name: performance-worker
spec:
  cpu:
    isolated: "2-19"
    reserved: "0-1"
  hugepages:
    defaultHugepagesSize: "1G"
    pages:
      - count: 4
        size: "1G"
        node: 0
  realTimeKernel:
    enabled: true
  numa:
    topologyPolicy: "restricted"
  nodeSelector:
    node-role.kubernetes.io/worker-cnf: ""

üß† Explanation
| Field                    | Description                                        |
| ------------------------ | -------------------------------------------------- |
| `cpu.isolated`           | CPUs dedicated to workloads (no OS processes)      |
| `cpu.reserved`           | CPUs for system and kernel threads                 |
| `hugepages`              | Allocate large memory pages for better performance |
| `realTimeKernel.enabled` | Enables the real-time kernel (if available)        |
| `nodeSelector`           | Applies to specific nodes (e.g., CNF worker nodes) |
| `numa.topologyPolicy`    | Ensures NUMA alignment for low latency             |

üîÑ What Happens When You Apply It
Performance Addon Operator reads the PerformanceProfile.
It generates:
A MachineConfig (for kernel args, hugepages, etc.)
A Tuned profile (for sysctl and scheduling)
MCO applies the MachineConfig.
NTO applies the Tuned configuration.
Nodes are rebooted if kernel changes are needed.
Nodes come back tuned and ready for high-performance workloads.

üîç Check Applied Profile
oc get performanceprofile
oc describe performanceprofile performance-worker
oc get machineconfig | grep performance
oc get tuned -n openshift-cluster-node-tuning-operator

üß© 6. CPU Isolation Concept (Key for Low Latency)
CPU isolation ensures:
User workloads run on specific CPU cores.
System processes (kubelet, CRI-O, etc.) stay off those cores.
This eliminates ‚Äúnoise‚Äù and improves determinism.

Example CPU Layout:
| Core | Assigned To                      |
| ---- | -------------------------------- |
| 0-1  | System (reserved)                |
| 2-19 | Application workloads (isolated) |

üß† 7. Relationship Between NTO, MCO, and PAO
| Component | Purpose                                      | Example Output              |
| --------- | -------------------------------------------- | --------------------------- |
| **MCO**   | Applies kernel arguments, updates OS configs | `oc get machineconfig`      |
| **NTO**   | Applies Tuned system parameters              | `oc get tuned`              |
| **PAO**   | Combines both for low-latency nodes          | `oc get performanceprofile` |

üìä Flow Diagram
PerformanceProfile
     ‚Üì
Performance Addon Operator
     ‚Üì
+---------------------+---------------------+
| MachineConfig (MCO) | Tuned Profile (NTO) |
+---------------------+---------------------+
        ‚Üì                     ‚Üì
     Node Reboot         System Parameters Applied
        ‚Üì                     ‚Üì
      Optimized Node Ready for Low-Latency Workloads

üßæ 8. Commands Summary
| Task                      | Command                                                          |            |
| ------------------------- | ---------------------------------------------------------------- | ---------- |
| List tuned profiles       | `oc get tuned -n openshift-cluster-node-tuning-operator`         |            |
| Describe tuned daemonset  | `oc describe ds tuned -n openshift-cluster-node-tuning-operator` |            |
| List performance profiles | `oc get performanceprofile`                                      |            |
| Check applied kernel args | `oc debug node/<nodename> -- cat /proc/cmdline`                  |            |
| Verify hugepages          | `oc debug node/<nodename> -- cat /proc/meminfo                   | grep Huge` |

üöÄ 9. Example Use Cases
| Use Case                      | Tuning Objective                             |
| ----------------------------- | -------------------------------------------- |
| **Telco RAN workloads**       | Low latency, real-time kernel, CPU isolation |
| **AI/ML inference nodes**     | High throughput, hugepages, NUMA alignment   |
| **Storage nodes (Ceph, ODF)** | Network & IO tuning                          |
| **NFV (DPDK)**                | Real-time, IRQ pinning, CPU affinity         |

‚ö†Ô∏è 10. Key Considerations
PerformanceProfile changes trigger node reboots ‚Äî apply carefully.
All tuning is role-based (through nodeSelector).
Use MachineConfigPool to group tuned nodes.

Validate results via:
oc adm node-tuning status
oc describe node <nodename> | grep machineconfiguration

üß† Summary Table
| Component                        | Managed By             | Function                                      |
| -------------------------------- | ---------------------- | --------------------------------------------- |
| Node Tuning Operator (NTO)       | Cluster Operator       | Applies Tuned system profiles                 |
| Tuned CRD                        | User-defined           | Custom sysctl/kernel configs                  |
| Performance Addon Operator (PAO) | Optional Operator      | Advanced tuning + CPU/NUMA management         |
| PerformanceProfile               | User-defined           | Describes CPU, kernel, and memory tuning      |
| MCO                              | MachineConfig Operator | Applies kernel-level config and reboots nodes |

